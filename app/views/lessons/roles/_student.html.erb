<% if @lesson.content_type == "quiz" %>
<% else %>
  <div class="card mb-4">
    <div class="card-header">
      <h3 class="mb-0">
        <% if @user_response %>
          <i class="fas fa-check-circle text-success me-2"></i>Your Submission
        <% else %>
          <i class="fas fa-edit me-2"></i>Your Response
        <% end %>
      </h3>
    </div>
    <div class="card-body">
      <% if @user_response %>
        <div class="response-content mb-4">
          <h5>Your Answer:</h5>
          <div class="bg-light p-3 rounded">
            <%= simple_format(@user_response.content) %>
          </div>
        
        <% if @user_response.attachment.present? %>
          <div class="mt-3">
            <h5>Attached File:</h5>
            <div class="p-3 bg-light rounded">
              <%= render_attachment(@user_response.attachment) %>
            </div>
          </div>
        <% end %>
        
        <% if @user_response.mark.present? %>
          <div class="mt-4 pt-3 border-top">
            <h5>Feedback:</h5>
            <div class="alert alert-light">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Grade:</strong>
                <span class="badge bg-<%= @user_response.mark.value.to_i >= 5 ? "success" : "warning" %>">
                  <%= @user_response.mark.value %> / 100
                </span>
              </div>
              <% @response_mark.each do |mark| %>
                <div class="feedback-comment mt-2 p-2 bg-white rounded">
                  <strong>Instructor's Note:</strong>
                  <p class="mb-0"><%= mark.comment %></p>
                </div>
              <% end %>
            </div>
          </div>
        <% else %>
          <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>Your submission has been received. The instructor will review it shortly.
          </div>
        <% end %>
      </div>
    <% else %>
      <% if @lesson.is_open? %>
        <div class="response-form">
          <%= form_with url: course_lesson_responses_path(@lesson.topic.course, @lesson), local: true, html: { class: "needs-validation", novalidate: true } do |f| %>
            <% @lesson.questions.each do |question| %>
              <div class="mb-4">
                <strong><%= question.title %></strong>
                <%= fields_for "responses[]", Response.new do |rf| %>
                  <%= rf.hidden_field :question_id, value: question.id %>
                  <%= rf.text_area :content, class: "form-control", rows: 2, placeholder: "Ваш ответ..." %>
                <% end %>
              </div>
            <% end %>
            <div class="d-flex justify-content-end">
              <%= f.submit "Отправить все ответы", class: "btn btn-primary", data: { disable_with: "Submitting..." } %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          The submission period for this assignment has ended.
        </div>
      <% end %>
    <% end %>
    </div>
    <% if @user_response && @user_response.updated_at != @user_response.created_at %>
      <div class="card-footer text-muted small">
        Last updated: <%= time_ago_in_words(@user_response.updated_at) %> ago
      </div>
    <% end %>
  </div>
<% end %>
