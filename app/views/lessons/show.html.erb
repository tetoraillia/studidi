<div class="container">
  <div class="center">
    <nav>
      <ul>
        <li><%= link_to "Responses", total_responses_path(current_user), class: "btn btn-primary" %></li>
        <li><%= link_to "Courses", courses_path, class: "btn btn-primary" %></li>
        <li><%= link_to "Bookmarks", bookmarks_path(current_user), class: "btn btn-primary" %></li>
      </ul>
    </nav>

    <div class="lesson-container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1><%= @lesson.title %></h1>
          <p class="text-muted mb-0">
            Course: <%= link_to @course.title, course_path(@course), class: "text-decoration-none" %>
            <span class="mx-2">â€¢</span>
            Topic: <%= link_to @topic.title, course_topic_path(@course, @topic), class: "text-decoration-none" %>
          </p>
        </div>
        <div class="lesson-actions">
          <% if policy(@lesson).update? %>
            <%= link_to "Edit", edit_course_topic_lesson_path(@course, @topic, @lesson), class: "btn btn-outline-secondary btn-sm" %>
          <% end %>
          <%= link_to "Back to Topic", course_topic_path(@course, @topic), class: "btn btn-outline-secondary btn-sm ms-2" %>
          <% if @lesson.content_type == "quiz" %>
            <% if @user.role.in?(%w[teacher])  %>
              <%= link_to "Add Question", new_course_topic_lesson_question_path(@course, @topic, @lesson), class: "btn btn-outline-secondary btn-sm ms-2" %>
            <% end %>
          <% end %>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <div class="lesson-content">
            <%= render partial: "lessons/types/#{@lesson.content_type}", locals: { lesson: @lesson } %>
          </div>
          
          <div class="lesson-meta mt-3 pt-3 border-top">
            <p class="text-muted mb-0">
              <i class="far fa-clock me-1"></i> Accepting answers until: 
              <strong><%= @lesson.end_date.present? ? DateTime.parse(@lesson.end_date.to_s).strftime("%B %d, %Y at %I:%M %p") : "No end date set" %></strong>
            </p>
          </div>
        </div>
      </div>


      <% if @user.role.in?(%w[student teacher]) %>
        <div class="lesson-interaction">
          <%= render partial: "lessons/roles/#{@user.role}", locals: { 
            lesson: @lesson, 
            response: @response, 
            user_response: @user_response,
            responses: @responses,
            mark: @mark
          } %>
        </div>
      <% else %>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          You don't have permission to interact with this lesson.
        </div>
      <% end %>
    </div>
  </div>
</div>
