<div class="container">
  <div class="left-side">
    <% if current_user.present? %>
      <div class="user-profile">
        <%= image_tag current_user.avatar.present? ? current_user.avatar.url : "default_avatar.jpg", class: "user-avatar" %>
        <div class="user-info">
          <p class="user-name"><%= current_user.first_name %></p>
          <p class="user-email"><%= current_user.email %></p>
          <p class="user-role"><%= current_user.role %></p>
          <% if current_user.teacher? %>
            <p class="user-stats">Created courses: <%= current_user.courses.count %></p>
          <% else %>
            <p class="user-stats">Enrolled courses: <%= current_user.enrollments.count %></p>
          <% end %>
        </div>
        <div class="user-actions">
          <%= button_to "Log Out", destroy_user_session_path, method: :delete, 
                       data: { confirm: "Are you sure you want to log out?" }, 
                       class: "btn btn-outline-secondary" %>
          <%= link_to "Edit profile", edit_user_registration_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>
    <% else %>
      <div class="auth-buttons">
        <%= link_to "Sign In", new_user_session_path, class: "btn btn-outline-primary" %>
        <%= link_to "Sign Up", new_user_registration_path, class: "btn btn-outline-primary" %>
      </div>
    <% end %>
  </div>
<br>
  <div class="center">
  <% if current_user %>
    <div class="search-container">
      <%= search_form_for @q, url: courses_path, method: :get do |f| %>
        <span class="search-field">
          <%= f.label :title_cont, "Title" %>
          <%= f.search_field :title_cont, placeholder: "Search title" %>
        </span>
        <span class="search-field">
          <%= label_tag 'q[lessonable]', 'Has Lessons' %>
          <%= check_box_tag 'q[lessonable]', '1', params.dig(:q, :lessonable) == '1' %>
        </span>
        <span class="search-field">
          <%= label_tag 'q[enrolled]', 'My Courses' %>
          <%= check_box_tag 'q[enrolled]', '1', params.dig(:q, :enrolled) == '1' %>
        </span>
        <span class="search-field">
          <%= label_tag 'q[recent]', 'Recent Courses' %>
          <%= check_box_tag 'q[recent]', '1', params.dig(:q, :recent) == '1' %>
        </span>
        <span class="search-field">
          <%= label_tag 'q[description_cont]', 'Description' %>
          <%= text_field_tag 'q[description_cont]', params.dig(:q, :description_cont), placeholder: 'Search description' %>
        </span>
        <br>
        <span class="search-actions">
          <%= f.submit "Search", class: "btn btn-primary" %>
          <%= link_to 'Clear', courses_path, class: 'btn btn-secondary' %>
          <%= sort_link(@q, :title, "Title") %>
        </span>
      <% end %>
    </div>
    <nav>
      <ul>
        <li>
          <%= link_to "Responses", total_responses_path(current_user), 
                       class: "btn btn-primary" %>
        </li>
        <li>
          <%= link_to "Courses", courses_path, 
                         class: "btn btn-primary" %>
        </li>
        <li>
          <%= link_to "Bookmarks", bookmarks_path(current_user), 
                         class: "btn btn-primary" %>
        </li>
      </ul>
    </nav>
    <% end %>
    <br>
    <% if policy(Course).create? %>
      <div class="new-course-button">
        <%= link_to "New Course", new_course_path, class: "btn btn-outline-primary" %>
      </div>
    <% end %>

    <div class="courses-list">
      <% @courses.each do |course| %>
        <div class="course">
          <div class="course-header">
            <h3 class="course-title"><%= course.title %></h3>
            <div class="course-meta">
              <p class="instructor">Instructor: <%= course.instructor.first_name %></p>
              <% if course.is_archived %>
                <span class="badge badge-public">Archived</span>
              <% end %>
                
              </span>
              <span class="badge <%= course.public ? "badge-public" : "badge-private" %>">
                <%= course.public ? "Public" : "Private" %>
              </span>
              <% if current_user&.student? && current_user.enrolled_in?(course) %>
                <span class="badge badge-enrolled">Enrolled</span>
              <% end %>
            </div>
          </div>
          <p class="course-description"><%= course.description %></p>
          <div class="course-actions">
            <%= link_to "View", course_path(course), class: "course-link course-link-primary" %>
            <% if current_user&.student? && !current_user.enrolled_in?(course) && course.public %>
              <%= button_to "Enroll in Course", 
                        course_enrollments_path(course), 
                        method: :post, 
                        class: "course-link course-link-primary" %>
            <% end %>
            <% if current_user&.student? && current_user.enrolled_in?(course) %>
              <%= button_to "Leave", course_enrollment_path(course, current_user.enrollments.find_by(course: course)), 
                           method: :delete, 
                           data: { confirm: "Are you sure you want to leave this course?" }, 
                           class: "course-link course-link-danger" %>
            <% end %>
            <% if policy(course).update? %>
              <%= link_to "Edit", edit_course_path(course), class: "course-link course-link-warning" %> 
              <%= button_to "Delete", course_path(course), 
                         method: :delete,
                         data: { confirm: "Are you sure?" },
                         class: "course-link course-link-danger" %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
