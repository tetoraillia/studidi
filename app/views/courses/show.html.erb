<div class="container py-4">
  <!-- Course Header Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h1 class="display-5 mb-2"><%= @course.title %></h1>
          <div class="d-flex align-items-center gap-2 mb-3">
            <span class="badge <%= @course.public ? "bg-success" : "bg-secondary" %>">
              <%= @course.public ? "Public" : "Private" %>
            </span>
            <% if @course.is_archived %>
              <span class="badge bg-warning text-dark">Archived</span>
            <% end %>
          </div>
        </div>
        <div class="d-flex gap-2">
          <% if policy(@course).update? %>
            <%= link_to new_course_topic_path(@course), class: "btn btn-primary" do %>
              <i class="fas fa-plus me-1"></i> New Topic
            <% end %>
            <%= link_to edit_course_path(@course), class: "btn btn-outline-secondary" do %>
              <i class="fas fa-edit me-1"></i> Edit
            <% end %>
          <% end %>
          <% if policy(@course).invite? %>
            <%= link_to invite_course_path(@course), class: "btn btn-outline-success" do %>
              <i class="fas fa-user-plus me-1"></i> Invite
            <% end %>
          <% end %>
          <%= button_to bookmarks_path(course_id: @course.id), 
                      method: @bookmarked ? :delete : :post, 
                      class: "btn #{@bookmarked ? 'btn-warning' : 'btn-outline-primary'}" do %>
            <i class="<%= @bookmarked ? "fas" : "far" %> fa-bookmark me-1"></i>
            <%= @bookmarked ? "Unbookmark" : "Bookmark" %>
          <% end %>
        </div>
      </div>

      <p class="lead"><%= @course.description %></p>
      
      <div class="d-flex flex-wrap gap-3 align-items-center mt-3 pt-3 border-top">
        <div class="d-flex align-items-center text-muted">
          <i class="fas fa-chalkboard-teacher me-2"></i>
          <span>Instructor: <%= @course.instructor.first_name %></span>
        </div>
        
        <% if @course.ends_at.present? %>
          <div class="d-flex align-items-center text-muted">
            <i class="far fa-calendar-alt me-2"></i>
            <span>Ends: <%= @course.ends_at.strftime("%B %d, %Y") %></span>
          </div>
        <% end %>
        
        <% if user_signed_in? && current_user.student? && !@course.enrolled?(current_user) %>
          <%= button_to course_enrollments_path(@course), 
                      method: :post, 
                      class: "btn btn-success ms-auto" do %>
            <i class="fas fa-user-plus me-1"></i> Enroll in Course
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
      <!-- Topics Section -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Course Topics</h2>
          <% if policy(@course).update? && @topics.any? %>
            <%= link_to new_course_topic_path(@course), class: "btn btn-sm btn-outline-primary" do %>
              <i class="fas fa-plus me-1"></i> Add Topic
            <% end %>
          <% end %>
        </div>
        
        <div class="card-body">
          <% if @topics.any? %>
            <%= search_form_for @lesson_q, url: course_path(@course), method: :get, html: { class: "lesson-search d-flex mb-3" } do |f| %>
  <%= f.search_field :title_cont, placeholder: "Search lessons...", class: "form-control me-2" %>
  <%= f.button :submit, class: "btn btn-primary btn-sm d-flex align-items-center" do %>
    <i class="fas fa-search me-1"></i> Search
  <% end %>
  <% if params.dig(:q, :title_cont).present? %>
    <%= link_to "Clear", course_path(@course), class: "btn btn-link btn-sm" %>
  <% end %>
<% end %>

<div class="accordion" id="topicsAccordion">
              <% @topics.each_with_index do |topic, index| %>
                <div class="accordion-item border-0 mb-2">
                  <h3 class="accordion-header" id="heading<%= topic.id %>">
                    <button class="accordion-button <%= index.zero? ? "" : "collapsed" %> shadow-none" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapse<%= topic.id %>" 
                            aria-expanded="<%= index.zero? ? "true" : "false" %>" 
                            aria-controls="collapse<%= topic.id %>">
                      <div class="d-flex justify-content-between align-items-center w-100">
                        <span class="fw-bold"><%= topic.title %></span>
                        <span class="badge bg-primary rounded-pill ms-2"><%= topic.lessons.count %> lessons</span>
                      </div>
                    </button>
                  </h3>
                  
                  <div id="collapse<%= topic.id %>" 
                       class="accordion-collapse collapse <%= index.zero? ? "show" : "" %>" 
                       aria-labelledby="heading<%= topic.id %>" 
                       data-bs-parent="#topicsAccordion">
                    <div class="accordion-body pt-3">
                      <% lessons = @lessons_by_topic[topic.id] || [] %>
                      <% if lessons.any? %>
                        <div class="list-group list-group-flush">
                          <% lessons.each do |lesson| %>
                            <%= link_to course_topic_lesson_path(@course, topic, lesson), 
                                      class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center" do %>
                              <span><%= lesson.title %></span>
                              <span class="badge bg-light text-dark"><%= lesson.content_type %></span>
                            <% end %>
                          <% end %>
                        </div>
                      <% else %>
                        <div class="text-muted text-center py-3">
                          No lessons in this topic yet.
                        </div>
                      <% end %>
                      
                      <% if policy(topic).edit? %>
                        <div class="mt-3 d-flex gap-2">
                          <%= link_to edit_course_topic_path(@course, topic), 
                                    class: "btn btn-sm btn-outline-secondary" do %>
                            <i class="fas fa-edit me-1"></i> Edit
                          <% end %>
                          <%= link_to select_lesson_type_course_topic_lessons_path(@course, topic),
                                    class: "btn btn-sm btn-primary" do %>
                            <i class="fas fa-plus me-1"></i> Add Lesson
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
              <h4>No topics yet</h4>
              <p class="text-muted">Get started by adding your first topic</p>
              <% if policy(@course).update? %>
                <%= link_to new_course_topic_path(@course), class: "btn btn-primary" do %>
                  <i class="fas fa-plus me-1"></i> Create First Topic
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Participants Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h3 class="h6 mb-0">
            <i class="fas fa-users me-2"></i>Participants
            <span class="badge bg-primary rounded-pill ms-1"><%= @course.enrollments.count + 1 %></span>
          </h3>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <!-- Instructor -->
            <div class="list-group-item d-flex align-items-center">
              <div class="flex-shrink-0 me-3">
                <div class="avatar-sm bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center rounded-circle">
                  <i class="fas fa-chalkboard-teacher"></i>
                </div>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0"><%= @course.instructor.first_name %></h6>
                <small class="text-muted">Instructor</small>
              </div>
            </div>
            
            <!-- Students -->
            <% @course.enrollments.each do |enrollment| %>
              <div class="list-group-item d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <div class="avatar-sm bg-light text-muted d-flex align-items-center justify-content-center rounded-circle">
                    <i class="fas fa-user-graduate"></i>
                  </div>
                </div>
                <div class="flex-grow-1 d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-0"><%= enrollment.user.first_name %></h6>
                    <small class="text-muted">Student</small>
                  </div>
                  <% if policy(enrollment).destroy? %>
                    <%= button_to kick_course_enrollment_path(@course, enrollment), 
                                method: :delete,
                                class: "btn btn-sm btn-outline-danger btn-icon",
                                data: { confirm: "Are you sure you want to remove this student?" },
                                title: "Remove student" do %>
                      <i class="fas fa-times"></i>
                      <span class="visually-hidden">Remove student</span>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      
      <!-- Course Actions Card -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h3 class="h6 mb-0"><i class="fas fa-cog me-2"></i>Course Actions</h3>
        </div>
        <div class="list-group list-group-flush">
          <%= link_to courses_path, class: "list-group-item list-group-item-action" do %>
            <i class="fas fa-arrow-left me-2"></i> Back to Courses
          <% end %>
          
          <% if policy(@course).destroy? %>
            <%= button_to @course, 
                        method: :delete, 
                        class: "list-group-item list-group-item-action text-danger",
                        data: { confirm: "Are you sure you want to delete this course? This action cannot be undone." } do %>
              <i class="fas fa-trash-alt me-2"></i> Delete Course
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
